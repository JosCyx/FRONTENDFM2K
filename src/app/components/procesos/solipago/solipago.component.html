<app-menu></app-menu>
<div class="container">
  <h2 class="font-weight-bolt ruteo">Solicitud de Pago</h2>
  <div class="">
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
        <div class="navbar-nav">
          <button class="btn btn-primary m-2" (click)="changeView('crear')">
            Crear
          </button>
          <button class="btn btn-primary m-2">Boton</button>
        </div>
      </div>
    </nav>
  </div>

  <div class="form-cot" *ngIf="changeview === 'crear'">
    <!-- Aqui iría la condicion para mostrar u ocultar el contenido -->
    <h3 class="font-weight-bold" style="padding-top: 20pt">
      Registrar nueva solicitud de pago
    </h3>

    <div class="solicitud">
      <div class="cabecera mb-3">
        <div class="row">
          <div class="input-group col mb-1">
            <label class="input-group-text">Fecha:</label>
            <input
              type="text"
              class="form-control"
              disabled
              [value]="fechaFormateada"
            />
          </div>
          <!--  -->
          <div class="input-group col mb-1">
            <label class="input-group-text">No orden de compra :</label>
            <input
              type="text"
              class="form-control"
              placeholder="Ingrese el numero de compra"
              [(ngModel)]="cab_ordencompra"
            />
          </div>
        </div>
        <div class="row mb-1">
          <div class="input-group col">
            <label class="input-group-text">Solicitado por*:</label>
            <input
              type="text"
              class="form-control"
              id="busqueda"
              list="sugerencias"
              [(ngModel)]="empleado"
              (keyup)="searchEmpleado()"
              placeholder="Ingrese el nombre del empleado"
            />
            <datalist id="sugerencias">
              <ng-container *ngFor="let emp of empleados">
                <option
                  [value]="emp.empleadoNombres + ' ' + emp.empleadoApellidos"
                ></option>
              </ng-container>
            </datalist>
            <button class="btn btn-success" (click)="selectEmpleado()">
              <i class="bi bi-check-lg"></i>
            </button>
          </div>
          <div class="input-group col">
            <label class="input-group-text">Area:</label>
            <input
              type="text"
              class="form-control"
              [value]="showArea"
              disabled 
            />
          </div>
          <!--  -->
        </div>
        <div class="row">
          <div class="input-group col mb-1">
            <label class="input-group-text">No factura:</label>
            <input
              type="text"
              class="form-control"
              placeholder="Ingrese el numero Factura"
              [(ngModel)]="cab_nofactura"
            />
          </div>
          <div class="input-group col mb-1">
            <label class="input-group-text">Fecha de Factura:</label>
            <input
              type="date"
              class="form-control"
              [(ngModel)]="cab_fechafactura"
            />
          </div>
        </div>
        <div class="row mb-1">
          <div class="input-group col">
            <select
              class="form-select"
              style="background-color: #d6d6d6"
              [(ngModel)]="tipobusqueda"
              (ngModelChange)="limpiarCampos()"
            >
              <option value="nombre" selected>Proveedor</option>
              <option value="ruc">Ruc</option>
            </select>
            <!--  -->
            <input
              *ngIf="tipobusqueda == 'nombre'"
              [(ngModel)]="buscarProveedor"
              type="text"
              class="form-control"
              list="proveedor"
              (keyup)="searchProveedor(buscarProveedor)"
            />
            <input
              *ngIf="tipobusqueda == 'ruc'"
              [(ngModel)]="buscarProveedor"
              type="text"
              class="form-control"
              list="proveedor"
            />
            <datalist id="proveedor" *ngIf="tipobusqueda === 'nombre'">
              <ng-container *ngFor="let prov of proveedores">
                <option [value]="prov.prov_nombre"></option>
              </ng-container>
            </datalist>
            <button
              *ngIf="tipobusqueda == 'ruc'"
              class="btn btn-success"
              (click)="searchProveedorRuc(buscarProveedor)"
            >
              <i class="bi bi-check-lg"></i>
            </button>
          </div>
          <div class="input-group col">
            <label class="input-group-text">
              <span *ngIf="tipobusqueda == 'nombre'"> RUC:</span>
              <span *ngIf="tipobusqueda == 'ruc'">Nombre:</span>
            </label>
            <input
              type="text"
              class="form-control"
              *ngIf="tipobusqueda == 'nombre'"
              [(ngModel)]="cab_rucproveedor"
            />
            <input
              type="text "
              class="form-control"
              *ngIf="tipobusqueda == 'ruc'"
              [(ngModel)]="cab_proveedor"
            />
          </div>
        </div>
        <div class="input-group">
          <label class="input-group-text"> Solicitud Asociada</label>
          <input
            [(ngModel)]="valorinput"
            type="text"
            class="form-control mr-1"
            placeholder="Ingrese la Solicitud Asociada..."
          />
          <button class="btn btn-success" (click)="Obtener()">
            <i class="bi bi-search"></i>
          </button>
        </div>
      </div>

      <div class="detalle">
        <table class="table table-striped text-center">
          <thead>
            <tr>
              <th scope="col"></th>
              <th scope="col">Item a Cancelar*</th>
              <th scope="col">Cantidad contratada</th>
              <th scope="col">Cantidad recibida</th>
              <th scope="col">Valor unitario</th>
              <th scope="col">Subtotal</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let det of detalleSolPagos; let i = index">
              <th class="align-middle">{{ i + 1 }}</th>
              <td class="align-middle">
                <textarea
                  name="descripcion"
                  class="form-control"
                  rows="2"
                  cols="50"
                  disabled
                  >{{ det.itemDesc }}</textarea
                >
              </td>
              <td class="align-middle">
                <input
                  type="number"
                  class="form-control text-center"
                  [(ngModel)]="det.cantidadContrat"
                />
              </td>
              <td class="align-middle" style="width: 150px">
                <input
                  type="number"
                  class="form-control text-center"
                  [(ngModel)]="det.cantidadRecibid"
                />
              </td>
              <td class="align-middle cel-prep">
                <input
                  type="number"
                  class="form-control text-center"
                  [(ngModel)]="det.valorUnitario"
                />
              </td>
              <td class="align-middle">
                <input
                  type="number"
                  class="form-control text-center"
                  [(ngModel)]="det.subTotal"
                  (input)="calculoTotal()"
                />
              </td>
            </tr>
            <tr>
              <td class="align-middle text-end"></td>
              <td class="align-middle text-end"></td>
              <td class="align-middle text-end"></td>
              <td class="align-middle text-end"></td>
              <td class="align-middle text-end">Total</td>
              <td class="align-middle text-end">
                <input
                  type="number"
                  class="form-control text-center"
                  [(ngModel)]="Total"
                />
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="foot-cabecera">
        <div class="form-floating mb-3">
          <input
            type="text"
            class="form-control"
            id="floatingInput"
            placeholder=""
            [(ngModel)]="cab_observa"
          />
          <label for="floatingInput">Observaciones:</label>
        </div>
        <div class="form-floating mb-3">
          <input
            type="text"
            class="form-control"
            id="floatingInputM"
            placeholder=""
            [(ngModel)]="cab_aplicarmult"
          />
          <label for="floatingInputM">Aplicar multa:</label>
        </div>
        <div class="input-group mb-3">
          <label class="input-group-text">Valor a descontar:</label>
          <input
            class="form-control"
            type="number"
            placeholder="Ingrese el valor a descontar"
            [(ngModel)]="cab_valordescontar"
          />
          <label class="input-group-text">Pago total autorizado:</label>
          <input
            class="form-control"
            type="number"
            placeholder="Ingrese el valor Total"
            [(ngModel)]="cab_totalautorizado"
          />
        </div>
        <div class="input-group mb-3">
          <label class="input-group-text">Recibe:</label>
          <input
            type="text"
            class="form-control"
            id="busqueda"
            list="sugerencias"
            [(ngModel)]="receptor"
            (keyup)="searchEmpleado()"
            placeholder="Ingrese el nombre del empleado"
          />
          <datalist id="sugerencias">
            <ng-container *ngFor="let emp of empleados">
              <option
                [value]="emp.empleadoNombres + ' ' + emp.empleadoApellidos"
              ></option>
            </ng-container>
          </datalist>
          <label class="input-group-text">Fecha de Inspeccion*:</label>
          <input
            class="form-control"
            type="date"
            for="fechamaxima"
            [(ngModel)]="cab_fechaInspeccion"
          />
        </div>
        <div class="input-group mb-3">
          <label class="input-group-text">Cancelación de orden :</label>
          <select class="form-select" [(ngModel)]="cab_cancelarOrden">
            <option disabled selected>Seleccione un opcion....</option>
            <option value="TTL">TOTAL</option>
            <option value="PCL">PARCIAL</option>
          </select>
        </div>
        <div class="text-end">
          <p class="tip">*Campos obligatorios</p>
        </div>
      </div>
    </div>
    <!-- Mensaje de error  -->
    <div class="d-flex row">
      <div class="col">
        <div *ngIf="showmsj" class="alert alert-success" role="alert">
          <span
            ><i class="bi bi-check-circle-fill">{{ msjExito }}</i></span
          >
        </div>
        <div *ngIf="showmsjerror" class="alert alert-danger" role="alert">
          <span
            ><i class="bi bi-exclamation-triangle-fill">
              {{ msjError }}</i
            ></span
          >
        </div>
      </div>

      <div class="col text-end">
        <button
          class="btn btn-primary m-2"
          data-toggle="modal"
          data-target="#GuardarSolicitud"
          (click)="saveReceptor()"
        >
          Guardar
        </button>
        <button class="btn btn-danger m-2" (click)="cancelar()">
          Cancelar
        </button>
      </div>
    </div>
  </div>

  <div class="form-cot" *ngIf="changeview === 'editar'">
    <!-- Aqui iría la condicion para mostrar u ocultar el contenido -->
    <h3 class="font-weight-bold" style="padding-top: 20pt">
      Editar solicitud de pago
    </h3>
    <!-- Inicio -->
    <div class="tabs-edit">
      <ul class="nav nav-tabs">
          <li class="nav-item">
              <a class="nav-link" [ngClass]="{'active': actionEdit === 'edicion'}" (click)="selectEditAction('edicion')">Edición</a>
          </li>
          <li class="nav-item">
              <a class="nav-link" [ngClass]="{'active': actionEdit === 'documentacion'}" (click)="selectEditAction('documentacion')">Documentación</a>
          </li>
      </ul>
  </div>
    <!-- Fin -->
    <div class="solicitud">
      <div class="cabecera mb-3">
        <div class="row m-1" >
          <div class="input-group">
            <label class="input-group-text">Código:</label>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="cabecera.cabPagoNumerico"
              disabled
            />
          </div>
        </div>
        <div class="row">
          <div class="input-group col mb-1">
            <label class="input-group-text">Fecha:</label>
            <input
              type="text"
              class="form-control"
              disabled
              [value]="fechaFormateada"
            />
          </div>
          <!--  -->
          <div class="input-group col mb-1">
            <label class="input-group-text">No orden de compra :</label>
            <input
              type="text"
              class="form-control"
              placeholder="Ingrese el numero de compra"
              [(ngModel)]="cabecera.cabPagoNoOrdenCompra"
            />
          </div>
        </div>
        <div class="row mb-1">
          <div class="input-group col">
            <label class="input-group-text">Solicitado por*:</label>
            <ng-container *ngFor="let emPa of empleadoEdi">
              <input
                *ngIf="emPa.empleadoIdNomina == cabecera.cabPagoSolicitante"
                type="text"
                class="form-control"
                id="busqueda"
                list="sugerencias"
                [value]="emPa.empleadoNombres + ' ' + emPa.empleadoApellidos"
                disabled
              />
            </ng-container>
          </div>
          <div class="input-group col">
            <label class="input-group-text">Area:</label>
            <ng-container *ngFor="let are of areas">
              <input
                *ngIf="are.areaIdNomina == cabecera.cabPagoAreaSolicitante"
                type="text"
                class="form-control"
                [value]="are.areaDecp"
                disabled
              />
            </ng-container>
          </div>
          <!--  -->
        </div>
        <div class="row">
          <div class="input-group col mb-1">
            <label class="input-group-text">No factura:</label>
            <input
              type="text"
              class="form-control"
              placeholder="Ingrese el numero Factura"
              [(ngModel)]="cabecera.cabPagoNumFactura"
            />
          </div>
          <div class="input-group col mb-1">
            <label class="input-group-text">Fecha de Factura:</label>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="cabecera.cabPagoFechaFactura"
            />
          </div>
        </div>
        <div class="row mb-1">
          <div class="input-group col">
            <select
              name=""
              class="form-select"
              style="background-color: #d6d6d6"
              [(ngModel)]="tipobusqueda"
              (ngModelChange)="limpiarCampos()"
            >
              <option value="nombre" selected>Proveedor</option>
              <option value="ruc">Ruc</option>
            </select>
            <input
              [(ngModel)]="cabecera.cabPagoProveedor"
              *ngIf="tipobusqueda == 'nombre'"
              type="text"
              class="form-control"
              list="proveedor"
              (keyup)="searchProveedor(cabecera.cabPagoProveedor)"
            />
            <input
              [(ngModel)]="cabecera.cabPagoRucProveedor"
              *ngIf="tipobusqueda == 'ruc'"
              type="text"
              class="form-control"
              list="proveedor"
            />
            <datalist id="proveedor" *ngIf="tipobusqueda === 'nombre'">
              <ng-container *ngFor="let prov of proveedores">
                <option [value]="prov.prov_nombre"></option>
              </ng-container>
            </datalist>
            <button
              *ngIf="tipobusqueda == 'ruc'"
              class="btn btn-success"
              (click)="searchProveedorRuc(cabecera.cabPagoRucProveedor)"
            >
              <i class="bi bi-check-lg"></i>
            </button>
          </div>
          <div class="input-group col">
            <label class="input-group-text">
              <span *ngIf="tipobusqueda == 'nombre'"> RUC:</span>
              <span *ngIf="tipobusqueda == 'ruc'">Nombre:</span>
            </label>
            <input
              type="text "
              class="form-control"
              *ngIf="tipobusqueda == 'nombre'"
              [(ngModel)]="cabecera.cabPagoRucProveedor"
            />
            <input
              type="text "
              class="form-control"
              *ngIf="tipobusqueda == 'ruc'"
              [(ngModel)]="cabecera.cabPagoProveedor"
            />
          </div>
        </div>
        <div class="row">
          <div class="row col">
            <div class="input-group col">
              <label class="input-group-text">Estado:</label>
              <input
                type="text"
                class="form-control"
                [value]="estadoTexto"
                disabled
              />
            </div>
            <div class="input-group col">
              <label class="input-group-text">Traking:</label>
              <ng-container *ngFor="let nvTRK of nivelRut$ | async">
                <input
                  *ngIf="nvTRK.nivel === cabecera.cabPagoEstadoTrack"
                  type="text"
                  class="form-control"
                  [value]="nvTRK.descRuteo"
                  disabled
                />
              </ng-container>
            </div>
          </div>
        </div>
      </div>
      <div *ngIf="actionEdit == 'documentacion' " >
        <app-sp-documentacion [tipoSol]="sharedTipoSol" [noSol]="sharedNoSol" ></app-sp-documentacion>
      </div>
      <div class="detalle">
        <table class="table table-striped text-center">
          <thead>
            <tr>
              <th scope="col"></th>
              <th scope="col">Item a Cancelar*</th>
              <th scope="col">Cantidad contratada</th>
              <th scope="col">Cantidad recibida</th>
              <th scope="col">Valor unitario</th>
              <th scope="col">Subtotal</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let det of detallePago; let i = index">
              <th class="align-middle">{{ i + 1 }}</th>
              <td class="align-middle">
                <textarea
                  name="descripcion"
                  class="form-control"
                  rows="2"
                  cols="50"
                  disabled
                  >{{ det.detPagoItemDesc }}</textarea
                >
              </td>
              <td class="align-middle">
                <input
                  type="number"
                  class="form-control text-center"
                  [(ngModel)]="det.detPagoCantContratada"
                />
              </td>
              <td class="align-middle" style="width: 150px">
                <input
                  type="number"
                  class="form-control text-center"
                  [(ngModel)]="det.detPagoCantRecibida"
                />
              </td>
              <td class="align-middle cel-prep">
                <input
                  type="number"
                  class="form-control text-center"
                  [(ngModel)]="det.detPagoValUnitario"
                />
              </td>
              <td class="align-middle">
                <input
                  type="number"
                  class="form-control text-center"
                  [(ngModel)]="det.detPagoSubtotal"
                  (input)="calculoEditotal()"
                />
              </td>
            </tr>
            <tr>
              <td class="align-middle text-end"></td>
              <td class="align-middle text-end"></td>
              <td class="align-middle text-end"></td>
              <td class="align-middle text-end"></td>
              <td class="align-middle text-end">Total</td>
              <td class="align-middle text-end">
                <input
                  type="number"
                  class="form-control text-center"
                  [(ngModel)]="cabecera.cabpagototal"
                />
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="foot-cabecera">
        <div class="form-floating mb-3">
          <input
            type="text"
            class="form-control"
            id="floatingInput"
            [(ngModel)]="cabecera.cabPagoObservaciones"
          />
          <label for="floatingInput">Observaciones:</label>
        </div>
        <div class="form-floating mb-3">
          <input
            type="text"
            class="form-control"
            id="floatingInput"
            [(ngModel)]="cabecera.cabPagoAplicarMulta"
          />
          <label for="floatingInput">Aplicar multa:</label>
        </div>
        <div class="input-group mb-3">
          <label class="input-group-text">Valor a descontar:</label>
          <input
            class="form-control"
            type="number"
            placeholder="Ingrese el valor a descontar"
            [(ngModel)]="cabecera.cabPagoValorMulta"
          />
          <label class="input-group-text">Pago total autorizado:</label>
          <input
            class="form-control"
            type="number"
            placeholder="Ingrese el valor Total"
            [(ngModel)]="cabecera.cabPagoValorTotalAut"
          />
        </div>
        <div class="input-group mb-3">
          <label class="input-group-text">Recibe:</label>
          <input
            type="text"
            class="form-control"
            list="sugerenciasEdit"
            [(ngModel)]="receptor"
            (keyup)="searchEmpleado()"
          />
          <datalist id="sugerenciasEdit">
            <ng-container *ngFor="let emp of empleadoEdi">
              <option
                [value]="emp.empleadoNombres + ' ' + emp.empleadoApellidos"
              ></option>
            </ng-container>
          </datalist>
          <label class="input-group-text">Fecha de Inspeccion*:</label>
          <input
            class="form-control"
            type="text"
            for="fechamaxima"
            [(ngModel)]="cabecera.cabPagoFechaInspeccion"
          />
        </div>
        <div class="input-group mb-3">
          <label class="input-group-text">Cancelación de orden :</label>
          <select
            class="form-select"
            [(ngModel)]="cabecera.cabPagoCancelacionOrden"
          >
            <option disabled selected>Seleccione un opcion....</option>
            <option value="TTL">TOTAL</option>
            <option value="PCL">PARCIAL</option>
          </select>
        </div>
        <div class="text-end">
          <p class="tip">*Campos obligatorios</p>
        </div>
      </div>
    </div>
    <div class="d-flex row">
      <div class="col">
        <div *ngIf="showmsj" class="alert alert-success" role="alert">
          <span
            ><i class="bi bi-check-circle-fill">{{ msjExito }}</i></span
          >
        </div>
        <div *ngIf="showmsjerror" class="alert alert-danger" role="alert">
          <span
            ><i class="bi bi-exclamation-triangle-fill">
              {{ msjError }}</i
            ></span
          >
        </div>
      </div>

      <div class="col text-end">
        <button
          class="btn btn-primary m-2"
          data-toggle="modal"
          data-target="#GuardarPagoEdit"
          (click)="saveReceptor()"
        >
          Guardar
        </button>
        <button class="btn btn-danger m-2" (click)="cancelarEdi()">
          Cancelar
        </button>
      </div>
    </div>
  </div>
</div>
<!-- Modulo para guardar solicitud   -->
<div
  class="modal fade"
  #exampleModal
  id="GuardarSolicitud"
  data-backdrop="static"
  tabindex="-1"
  role="dialog"
  aria-labelledby="exampleModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header justify-content-center">
        <h3 class="font-weight-bold" id="exampleModalLabel">Guardar cambios</h3>
      </div>
      <div class="modal-body">
        <p>
          ¿Esta seguro que desea guardar los cambios realizados en la solicitud
          ?
        </p>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-primary"
          data-dismiss="modal"
          (click)="generarSolicitud()"
        >
          Confirmar
        </button>
        <button type="button" class="btn btn-danger" data-dismiss="modal">
          Cancelar
        </button>
      </div>
    </div>
  </div>
</div>
<!--Fin modulo enviar -->
<!-- Modulo para editar -->
<div
  class="modal fade"
  #exampleModal
  id="GuardarPagoEdit"
  data-backdrop="static"
  tabindex="-1"
  role="dialog"
  aria-labelledby="exampleModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header justify-content-center">
        <h3 class="font-weight-bold" id="exampleModalLabel">Guardar cambios</h3>
      </div>
      <div class="modal-body">
        <p>
          ¿Esta seguro que desea guardar los cambios realizados en la solicitud
          ?
        </p>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-primary"
          data-dismiss="modal"
          (click)="savePagoEdit()"
        >
          Confirmar
        </button>
        <button type="button" class="btn btn-danger" data-dismiss="modal">
          Cancelar
        </button>
      </div>
    </div>
  </div>
</div>
<!--  -->
