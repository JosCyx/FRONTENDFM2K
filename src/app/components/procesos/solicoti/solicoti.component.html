<app-menu></app-menu>
<div class="container">
    <h2 class="font-weight-bolt ruteo">Solicitud de Cotizacion</h2>
    <div class=" text center">
        <nav class="navbar navbar-expand-lg navbar-light bg-light" style="height: 30px;">
            <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                <div class="navbar-nav">
                    <!-- <button class="btn btn-primary m-2" (click)="changeView('crear')">
                        Crear
                    </button> -->
                    <!-- <button class="btn btn-danger" (click)="getNivelRuteoArea()">Boton</button>                     -->
                </div>
            </div>
        </nav>
    </div>
    <div class=" m-2 text-center">
        <div *ngIf="showmsj" class="alert alert-success" role="alert">
            <span><i class="bi bi-check-circle-fill"> {{ msjExito }}</i></span>
        </div>
        <div *ngIf="showmsjerror" class="alert alert-danger" role="alert">
            <span><i class="bi bi-exclamation-triangle-fill"> {{ msjError }}</i></span>
        </div>
    </div>

    <ng-container *appAuthorize="'25'">
        <div class="form-cot" *ngIf="changeview === 'crear'">
            <h3 class="font-weight-bold" style="padding-top: 20pt">
                Registrar nueva solicitud de cotización
            </h3>

            <div class="tabs-edit">
                <ul class="nav nav-tabs">
                    <li class="nav-item">
                        <a class="nav-link" [ngClass]="{'active': actionCreate === 'creacion'}"
                            (click)="selectCreateAction('creacion')">Creación</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" [ngClass]="{'active': actionCreate === 'proveedores'}" (click)="selectCreateAction('proveedores')
                            " (click)="setNoSol()">Proveedores</a>
                    </li>
                    <li class="nav-item" *ngIf="showDoc">
                        <a class="nav-link" [ngClass]="{'active': actionCreate === 'documentacion'}"
                            (click)="selectCreateAction('documentacion')">Documentación</a>
                    </li>
                </ul>
            </div>


            <div class="solicitud">
                <div class="cabecera mb-3">
                    <div class="input-group mb-1">
                        <label class="input-group-text">Fecha:</label>
                        <input type="text" class="form-control" disabled [(ngModel)]="fechaFormat" />
                    </div>
                    <div class="row mb-1">
                        <div class="input-group col">
                            <label class="input-group-text">Solicitado por*:</label>
                            <input type="text" class="form-control" id="busqueda" list="sugerencias"
                                [(ngModel)]="empleado" (keyup)="searchEmpleado()"
                                placeholder="Ingrese el nombre del empleado" />
                            <datalist id="sugerencias">
                                <ng-container *ngFor="let emp of empleados">
                                    <option [value]="emp.empleadoNombres + ' ' + emp.empleadoApellidos"></option>
                                </ng-container>
                            </datalist>
                            <button class="btn btn-success" (click)="selectEmpleado()">
                                <i class="bi bi-check-lg"></i>
                            </button>
                        </div>
                        <div class="input-group col">
                            <label class="input-group-text">Area:</label>
                            <input type="text" class="form-control" [value]="showArea"
                                placeholder="Area del empleado solicitante" disabled />
                        </div>
                    </div>
                    <div class="input-group mb-1">
                        <label class="input-group-text">Asunto*:</label>
                        <input type="text" class="form-control" placeholder="Ingrese el asunto"
                            [(ngModel)]="cab_asunto" />
                    </div>
                </div>

                <div class="detalle" *ngIf="actionCreate == 'creacion'">
                    <table class="table table-striped text-center">
                        <thead>
                            <tr>
                                <th scope="col">Item</th>
                                <th scope="col">Descripción*</th>
                                <th scope="col">Presupuesto*</th>
                                <th scope="col">Sector*</th>
                                <th scope="col">Unidad</th>
                                <th scope="col">Cantidad Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let det of detalleList">
                                <td class="align-middle">{{ det.det_id }}</td>
                                <td class="align-middle">{{ det.det_descp }}</td>
                                <ng-container *ngFor="let prep of presupuestos">
                                    <td class="align-middle" *ngIf="prep.prespId == det.det_presupuesto">{{
                                        prep.prespNombre }}</td>
                                </ng-container>
                                <td class="align-middle">
                                    <button class="btn btn-outline-primary" data-toggle="modal"
                                    (click)="CapturarIdDetalle(det.det_id)"
                                    data-target="#itemsectorview" >Editar</button>
                                </td>
                                <td class="align-middle">{{ det.det_unidad }}</td>
                                <td class="align-middle">
                                    {{ det.det_cantidad }}
                                    <button class="btn text-danger" (click)="deleteDetalle(det.det_id)">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <th class="align-middle">{{ det_id }}</th>
                                <td class="align-middle">
                                    <textarea name="descripcion" class="form-control  limited-textarea" rows="2"
                                        cols="50" placeholder="Descripción" [(ngModel)]="det_descp"></textarea>
                                </td>
                                <td class="align-middle">
                                    <select class="form-control" [(ngModel)]="det_presupuesto">
                                        <option value="0" selected disabled>presupuesto...</option>
                                        <option *ngFor="let prep of presupuestos" [value]="prep.prespId">
                                            {{prep.prespNombre}}</option>
                                    </select>
                                </td>
                                <td class="align-middle">
                                    <button class="btn btn-outline-primary" data-toggle="modal"
                                        data-target="#itemsector" [disabled]="!det_descp || !det_presupuesto">
                                        Desglose
                                    </button>
                                </td>
                                <td class="align-middle" style="width: 150px">
                                    <select class="form-control" [(ngModel)]="det_unidad">
                                        <option value="Unidad" selected>Unidad</option>
                                        <option value="Sacos">Sacos</option>
                                        <option value="Paquete">Paquete</option>
                                        <option value="Avance de Obra">Avance de Obra</option>
                                        <option value="Millar">Millar</option>
                                        <option value="Metros">Metros</option>
                                        <option value="Kilos">Kilos</option>
                                        <option value="Gramos">Gramos</option>
                                        <option value="Caneca">Caneca</option>
                                    </select>
                                </td>
                                <td class="align-middle cel-prep">
                                    <input type="text" class="form-control text-center" [(ngModel)]="det_cantidad"
                                        disabled />
                                </td>
                            </tr>
                            <tr>
                                <td colspan="6" class="align-middle text-end">
                                    <button class="btn btn-success" [disabled]="!det_descp || tmpItemSect.length === 0"
                                        (click)="addDetalle()">
                                        <i class="bi bi-check"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div *ngIf="actionCreate == 'documentacion'">
                    <app-cot-documentacion [view]="changeview" [tipoSol]="sharedTipoSol" [noSol]="sharedNoSol"
                        [estadoSol]="estadoSol"></app-cot-documentacion>
                </div>
                <div *ngIf="actionCreate == 'proveedores'">
                    <app-cot-proveedores [cabSolCotAsunto]="cabSolCotAsunto" [mail_detalles]="sharedDetalle"
                        [tipoSol]="sharedTipoSol" [noSol]="sharedNoSol" [estadoSol]="estadoSol"></app-cot-proveedores>
                </div>

                <div class="foot-cabecera">
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="floatingInput" [(ngModel)]="cab_proc"
                            placeholder="Materiales y procedimientos a seguir:" />
                        <label for="floatingInput">Materiales y procedimientos a seguir:</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="floatingInput" [(ngModel)]="cab_obsrv"
                            placeholder="Materiales y procedimientos a seguir:" />
                        <label for="floatingInput">Observaciones:</label>
                    </div>
                    <div class="input-group mb-3">
                        <label class="input-group-text">Adjunto cotizaciones:</label>
                        <select class="form-select" [(ngModel)]="cab_adjCot" (change)="setNoSolDocumentacion()">
                            <option value="SI">Sí</option>
                            <option value="NO" selected>No</option>
                        </select>
                        <label class="input-group-text">Número de cotizaciones:</label>
                        <input class="form-control" type="number" placeholder="Cantidad" [(ngModel)]="cab_ncot" />
                    </div>
                    <div class="input-group mb-3">
                        <label class="input-group-text">Plazo de entrega*:</label>
                        <input class="form-control" type="date" for="plazoentrega" [(ngModel)]="cab_plazo" />
                        <label class="input-group-text">Fecha máxima de entrega*:</label>
                        <input class="form-control" type="date" for="fechamaxima" [(ngModel)]="cab_fechaMax" />
                    </div>
                    <div class="input-group">
                        <label class="input-group-text">Inspector:</label>
                        <input type="text" class="form-control" id="busqueda" list="inspectores" [(ngModel)]="inspector"
                            (keyup)="searchInspector()" (input)="onInputChanged()"
                            placeholder="Ingrese el nombre del inspector" />
                        <datalist id="inspectores">
                            <ng-container *ngFor="let empOP of inspectores">
                                <option [value]="empOP.empleadoNombres + ' ' + empOP.empleadoApellidos"></option>
                            </ng-container>
                        </datalist>
                        <label class="input-group-text">Teléfono:</label>
                        <input class="form-control" type="text" placeholder="Ingrese el teléfono del inspector"
                            [(ngModel)]="cab_telef_insp" />
                    </div>
                    <div class="text-end">
                        <p class="tip">*Campos obligatorios</p>
                    </div>
                </div>
            </div>
            <div class="d-flex row">
                <div class="col">
                    <!-- <div *ngIf="showmsj" class="alert alert-success" role="alert">
                        <span><i class="bi bi-check-circle-fill"> {{ msjExito }}</i></span>
                    </div>
                    <div *ngIf="showmsjerror" class="alert alert-danger" role="alert">
                        <span><i class="bi bi-exclamation-triangle-fill"> {{ msjError }}</i></span>
                    </div> -->
                </div>

                <div class="col text-end">
                    <button class="btn btn-primary m-2" [disabled]="
                !empleado ||
                !cab_asunto ||
                detalleList.length === 0 ||
                itemSectorList.length === 0" data-toggle="modal" data-target="#guardarCotizacion" *appAuthorize="'25'">
                        Guardar
                    </button>
                    <button class="btn btn-success m-2" data-toggle="modal" data-target="#enviarSolicitud"
                        *appAuthorize="'27'">
                        Guardar y enviar
                    </button>
                    <button class="btn btn-danger m-2" (click)="cancelarAll()">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </ng-container>

    <ng-container *appAuthorize="'26'">
        <!-- Editar solicitud de cotizacion -->
        <div class="formRol" *ngIf="changeview === 'editar'">
            <h3 class="font-weight-bold" style="padding-top: 20pt">Editar solicitud</h3>

            <div class="tabs-edit">
                <ul class="nav nav-tabs">
                    <li class="nav-item">
                        <a class="nav-link" [ngClass]="{'active': actionEdit === 'edicion'}"
                            (click)="selectEditAction('edicion')">Edición</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" [ngClass]="{'active': actionEdit === 'proveedores'}"
                            (click)="selectEditAction('proveedores')">Proveedores</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" [ngClass]="{'active': actionEdit === 'documentacion'}"
                            (click)="selectEditAction('documentacion')">Documentación</a>
                    </li>
                    <ng-container
                        *ngIf="cabecera.cabSolCotEstadoTracking > 10 && cabecera.cabSolCotEstadoTracking != 0 && cabecera.cabSolCotEstadoTracking != 9999">
                        <li class="nav-item" *appAuthorize="'53'">
                            <a class="nav-link" [ngClass]="{'active': actionEdit === 'autorizacion'}"
                                (click)="selectEditAction('autorizacion')">Autorizacion</a>
                        </li>
                    </ng-container>
                </ul>
            </div>

            <div class="solicitudEdit">
                <div class="cabecera mb-3">
                    <div class="row mb-1">
                        <div class="input-group col">
                            <label class="input-group-text">Código:</label>
                            <input type="text" class="form-control" [(ngModel)]="cabecera.cabSolCotNumerico" disabled />
                        </div>
                        <div class="input-group col">
                            <label class="input-group-text">Fecha:</label>
                            <input type="text" class="form-control" [(ngModel)]="cabecera.cabSolCotFecha" disabled />
                        </div>
                    </div>

                    <div class="row mb-1">
                        <div class="input-group col">
                            <label class="input-group-text">Solicitado por:</label>
                            <ng-container *ngFor="let emp of empleadosEdit">
                                <input *ngIf="emp.empleadoIdNomina == cabecera.cabSolCotSolicitante" type="text"
                                    class="form-control" id="busqueda" list="sugerencias"
                                    [value]="emp.empleadoNombres + ' ' + emp.empleadoApellidos" disabled />
                            </ng-container>
                        </div>
                        <div class="input-group col">
                            <label class="input-group-text">Area:</label>
                            <ng-container *ngFor="let are of areas">
                                <input *ngIf="are.areaIdNomina == cabecera.cabSolCotIdArea" type="text"
                                    class="form-control" id="busqueda" list="sugerencias" [value]="are.areaDecp"
                                    disabled />
                            </ng-container>
                        </div>
                    </div>
                    <div class="row mb-1">
                        <div class="input-group col">
                            <label class="input-group-text">Aprobado por:</label>
                            <ng-container *ngIf="cabecera.cabSolCotApprovedBy === '000000'; else showValue">
                                <input type="text" class="form-control" value="Nivel no alcanzado." disabled />
                            </ng-container>
                            <ng-template #showValue>
                                <ng-container *ngFor="let emp of empleadosEdit">
                                    <input *ngIf="emp.empleadoIdNomina == cabecera.cabSolCotApprovedBy" type="text"
                                        class="form-control" id="busqueda"
                                        [value]="emp.empleadoNombres + ' ' + emp.empleadoApellidos" disabled />
                                </ng-container>
                            </ng-template>
                        </div>
                        <div class="input-group col">
                            <label class="input-group-text">Estado:</label>
                            <input type="text" class="form-control" [value]="estadoTexto" disabled />
                        </div>

                    </div>
                    <div class="row mb-1">
                        <div class="input-group col">
                            <label class="input-group-text">Apr. Financiera:</label>
                            <ng-container *ngIf="cabecera.cabSolCotFinancieroBy === '000000'; else showValue">
                                <input type="text" class="form-control" value="Nivel no alcanzado." disabled />
                            </ng-container>
                            <ng-template #showValue>
                                <ng-container *ngFor="let emp of empleadosEdit">
                                    <input *ngIf="emp.empleadoIdNomina == cabecera.cabSolCotFinancieroBy" type="text"
                                        class="form-control" 
                                        [value]="emp.empleadoNombres + ' ' + emp.empleadoApellidos" disabled />
                                </ng-container>
                            </ng-template>
                        </div>
                        <div class="input-group col">
                            <label class="input-group-text">Tracking:</label>
                            <ng-container *ngFor="let nvTRk of nivelRut$ | async">
                                <input *ngIf="nvTRk.nivel === cabecera.cabSolCotEstadoTracking" type="text"
                                    class="form-control" [value]="nvTRk.descRuteo" disabled />
                            </ng-container>
                        </div>

                    </div>
                    <div class="row mb-1">
                        <div class="input-group col">
                            <label class="input-group-text">Asunto:</label>
                            <input type="text" class="form-control" [(ngModel)]="cabecera.cabSolCotAsunto"
                                 [disabled]="cabecera.cabSolCotEstadoTracking > 10"/>
                        </div>
                    </div>

                    <div class="presupuestaria" *ngIf="aprobPreps">
                        <div class="tabs-edit">
                            <ul class="nav nav-tabs">
                                <li class="nav-item">
                                    <a class="nav-link" style="font-style: italic; font-weight: bold;"
                                        [ngClass]="{'active': 1}">Aprobación presupuestaria</a>
                                </li>
                            </ul>
                        </div>
                        <div class="row mb-1 align-items-center">
                            <div class="col-md-4">
                                <div class="input-group">
                                    <label class="input-group-text">Aprobación presupuestaria:</label>
                                    <select class="form-select" [(ngModel)]="cabecera.cabSolCotAprobPresup"
                                        [appSecureDisable]="estadoSol" (change)="setMotivoDev()">
                                        <option value="SI">Sí</option>
                                        <option value="NO">No</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="input-group" *ngIf="setMotivo == 'SI'">
                                    <label class="input-group-text">Motivo de devolución:</label>
                                    <textarea class="form-control limited-textarea" rows="1"
                                        placeholder="Ingrese el motivo de devolución"
                                        [(ngModel)]="cabecera.cabSolCotMtovioDev"
                                        [appSecureDisable]="estadoSol"></textarea>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>

                <div class="detalle" *ngIf="actionEdit == 'edicion'">
                    <table class="table table-striped text-center">
                        <thead>
                            <tr>
                                <th scope="col">Item</th>
                                <th scope="col">Descripción*</th>
                                <th scope="col">Presupuesto*</th>
                                <th scope="col">Sector*</th>
                                <th scope="col">Unidad</th>
                                <th scope="col">Cantidad Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngIf="item.length == 0">
                                <td class="text-danger" colspan="6">
                                    No se han registrado items para esta solicitud
                                </td>
                            </tr>
                            <tr *ngFor="let det of detalle; let i = index">
                                <td class="align-middle">{{ i+1 }}</td>
                                <td class="align-middle">
                                    <!-- <input type="text" class="form-control" [(ngModel)]="det.solCotDescripcion"></td> -->
                                    <textarea name="descripcion" class="form-control  limited-textarea" rows="2"
                                        cols="15" placeholder="Descripción" [(ngModel)]="det.solCotDescripcion"
                                        [disabled]="cabecera.cabSolCotEstadoTracking > 10"></textarea>
                                <td class="align-middle">
                                    <select class="form-control" [(ngModel)]="det.solCotPresupuesto"
                                    [disabled]="cabecera.cabSolCotEstadoTracking > 10">
                                        <option value="" selected disabled>>presupuesto...</option>
                                        <option *ngFor="let prep of presupuestos" [value]="prep.prespId">
                                            {{prep.prespNombre}}</option>
                                    </select>
                                </td>
                                <td class="align-middle"><button class="btn btn-outline-primary"
                                        (click)="selectDet(det)" data-toggle="modal" data-target="#itemsectorEdit"
                                        [disabled]="cabecera.cabSolCotEstadoTracking > 10">Editar</button></td>
                                <td class="align-middle">
                                    <select class="form-control" [(ngModel)]="det.solCotUnidad"
                                    [disabled]="cabecera.cabSolCotEstadoTracking > 10">
                                        <option value="Unidad">Unidad</option>
                                        <option value="Sacos">Sacos</option>
                                        <option value="Paquete">Paquete</option>
                                        <option value="Avance de Obra">Avance de Obra</option>
                                        <option value="Millar">Millar</option>
                                        <option value="Metros">Metros</option>
                                        <option value="Kilos">Kilos</option>
                                        <option value="Gramos">Gramos</option>
                                        <option value="Caneca">Caneca</option>
                                    </select>
                                </td>
                                <td class="align-middle">
                                    {{ det.solCotCantidadTotal }}
                                    <button class="btn text-danger btn-border"
                                        (click)="confDeleteDet(det.solCotID, det.solCotIdDetalle)" data-toggle="modal"
                                        data-target="#dltDetSaved" [appSecureDisable]="estadoSol">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                </td>
                            </tr>

                            <tr *ngIf="cabecera.cabSolCotEstadoTracking == 10">
                                <th class="align-middle">{{ det_id }}</th>
                                <td class="align-middle">
                                    <textarea name="descripcion" class="form-control  limited-textarea" rows="2"
                                        cols="10" placeholder="Descripción" [(ngModel)]="det_descp"
                                        [appSecureDisable]="estadoSol"></textarea>
                                </td>
                                <td class="align-middle">
                                    <select class="form-control" [(ngModel)]="det_presupuesto">
                                        <option value="0" selected disabled>Presupuesto</option>
                                        <option *ngFor="let prep of presupuestos" [value]="prep.prespId">
                                            {{prep.prespNombre}}</option>
                                    </select>
                                </td>
                                <td class="align-middle">
                                    <button class="btn btn-outline-primary" data-toggle="modal"
                                        data-target="#itemsector" [disabled]="!det_descp  || !det_presupuesto"
                                        (click)="openModalItem()" [appSecureDisable]="estadoSol">
                                        Desglose
                                    </button>
                                </td>
                                <td class="align-middle" style="width: 150px">
                                    <select class="form-control" [(ngModel)]="det_unidad"
                                        [appSecureDisable]="estadoSol">
                                        <option value="Unidad" selected>Unidad</option>
                                        <option value="Sacos">Sacos</option>
                                        <option value="Paquete">Paquete</option>
                                        <option value="Avance de Obra">Avance de Obra</option>
                                        <option value="Millar">Millar</option>
                                        <option value="Metros">Metros</option>
                                        <option value="Kilos">Kilos</option>
                                        <option value="Gramos">Gramos</option>
                                        <option value="Caneca">Caneca</option>
                                    </select>
                                </td>
                                <td class="align-middle cel-prep">
                                    <input type="text" class="form-control text-center" [(ngModel)]="det_cantidad"
                                        disabled [appSecureDisable]="estadoSol" />
                                </td>
                            </tr>
                            <tr *ngIf="cabecera.cabSolCotEstadoTracking == 10">
                                <td colspan="6" class="align-middle text-end">
                                    <button class="btn btn-success" [disabled]="!det_descp || tmpItemSect.length === 0"
                                        (click)="addDetalle()" [appSecureDisable]="estadoSol">
                                        <i class="bi bi-check"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div *ngIf="actionEdit == 'proveedores'">
                    <app-cot-proveedores [cabSolCotAsunto]="cabSolCotAsunto" [mail_detalles]="sharedDetalle"
                        [tipoSol]="sharedTipoSol" [noSol]="sharedNoSol" [estadoSol]="estadoSol"></app-cot-proveedores>
                </div>

                <div *ngIf="actionEdit == 'documentacion'">
                    <app-cot-documentacion [tipoSol]="sharedTipoSol" [noSol]="sharedNoSol"
                        [estadoSol]="estadoSol"></app-cot-documentacion>
                </div>

                <div *ngIf="actionEdit == 'autorizacion'">
                    <div class="anulacion mb-3">
                        <div class="m-2">
                            <h2>Autorización de solicitud</h2>
                            <div class="text-center">
                                <div class="row buttons-ruteo">
                                    <ng-container *appAuthorize="'54'">
                                        <button *ngIf="setMotivo == 'NO'" class="btn btn-success col m-2" data-toggle="modal"
                                            data-target="#aprobarSolicitud" [appSecureDisable]="estadoSol">Aprobar</button>
                                    </ng-container>
                                    <button *appAuthorize="'57'" class="btn btn-warning col m-2" data-toggle="modal"
                                        data-target="#rechazarSolicitud" [appSecureDisable]="estadoSol">Devolver</button>
                                    <button *appAuthorize="'60'" class="btn btn-danger col m-2" data-toggle="modal"
                                        data-target="#anularSolicitud" [appSecureDisable]="estadoSol">Anular</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- <app-cot-anulacion [tipoSol]="sharedTipoSol" [noSol]="sharedNoSol"
                        [estadoSol]="estadoSol" [setMotivo]="setMotivo"></app-cot-anulacion> -->
                </div>


                <div class="foot-cabecera">
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="floatingInput"
                            [(ngModel)]="cabecera.cabSolCotProcedimiento" [disabled]="cabecera.cabSolCotEstadoTracking > 10"/>
                        <label for="floatingInput">Materiales y procedimientos a seguir:</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="floatingInput"
                            [(ngModel)]="cabecera.cabSolCotObervaciones" [disabled]="cabecera.cabSolCotEstadoTracking > 10"/>
                        <label for="floatingInput">Observaciones:</label>
                    </div>
                    <div class="input-group mb-3">
                        <label class="input-group-text">Adjunto cotizaciones:</label>
                        <select class="form-control" [(ngModel)]="cabecera.cabSolCotAdjCot"
                        [disabled]="cabecera.cabSolCotEstadoTracking > 10">
                            <option value="SI">Sí</option>
                            <option value="NO" selected>No</option>
                        </select>
                        <label class="input-group-text">Número de cotizaciones:</label>
                        <input class="form-control" type="number" [(ngModel)]="cabecera.cabSolCotNumCotizacion"
                        [disabled]="cabecera.cabSolCotEstadoTracking > 10"/>
                    </div>
                    <div class="input-group mb-3">
                        <label class="input-group-text">Plazo de entrega:</label>
                        <input class="form-control" type="text" for="plazoentrega"
                            [(ngModel)]="cabecera.cabSolCotPlazoEntrega" [disabled]="cabecera.cabSolCotEstadoTracking > 10"/>
                        <label class="input-group-text">Fecha máxima de entrega:</label>
                        <input class="form-control" type="text" for="fechamaxima"
                            [(ngModel)]="cabecera.cabSolCotFechaMaxentrega" [disabled]="cabecera.cabSolCotEstadoTracking > 10"/>
                    </div>
                    <div class="input-group mb-1">
                        <label class="input-group-text">Inspector:</label>
                        <input type="text" class="form-control" id="busqueda" list="inspectores"
                            [(ngModel)]="nameInspector" (keyup)="searchInspectorEdit()"
                            [disabled]="cabecera.cabSolCotEstadoTracking > 10"/>
                        <datalist id="inspectores">
                            <ng-container *ngFor="let empOP of inspectoresEdit">
                                <option [value]="empOP.empleadoNombres + ' ' + empOP.empleadoApellidos"></option>
                            </ng-container>
                        </datalist>
                        <label class="input-group-text">Teléfono:</label>
                        <input class="form-control" type="text" [(ngModel)]="cabecera.cabSolCotTelefInspector"
                        [disabled]="cabecera.cabSolCotEstadoTracking > 10"/>
                    </div>
                    <div class="row justify-content-between ">
                        <app-cot-pdf class="text-end"></app-cot-pdf>
                    </div>
                </div>
            </div>
            <div class="d-flex row mt-2">
                <div class="col">
                    <!-- <div *ngIf="showmsj" class="alert alert-success" role="alert">
                        <span><i class="bi bi-check-circle-fill"> {{ msjExito }}</i></span>
                    </div>
                    <div *ngIf="showmsjerror" class="alert alert-danger" role="alert">
                        <span><i class="bi bi-exclamation-triangle-fill">
                                {{ msjError }}</i></span>
                    </div> -->
                </div>
                <div class="col text-end">
                    <ng-container *ngIf="cabecera.cabSolCotEstadoTracking == 10">
                        <button class="btn btn-primary m-2" data-toggle="modal" data-target="#guardarEdicion"
                            (click)="saveIdInspector()" [appSecureDisable]="estadoSol">Guardar</button>
                        <button class="btn btn-success m-2" data-toggle="modal" data-target="#enviarSolicitudGuardada"
                            [appSecureDisable]="estadoSol" *appAuthorize="'27'">
                            Guardar y enviar
                        </button>
                    </ng-container>
                    <button class="btn btn-danger m-2" (click)="cancelar()">Cancelar</button>
                </div>
            </div>


        </div>
    </ng-container>
</div>

<!-- Modal para los items por sector-->
<div class="modal fade" #exampleModal id="itemsectorview" data-backdrop="static" tabindex="-1" role="dialog"
    aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header justify-content-center">
                <h3 class="font-weight-bold" id="exampleModalLabel">
                    Ingrese los items según el sector
                </h3>
            </div>
            <div class="modal-body">
                <table class="table table-striped text-center justify-content-center">
                    <thead>
                        <tr>
                            <th scope="col">N° Detalle</th>
                            <th scope="col">Descripción</th>
                            <th scope="col">N° Item</th>
                            <th scope="col">Cantidad*</th>
                            <th scope="col" colspan="2">Sector*</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let item of itemSectorList">
                            <ng-container  *ngIf="item.det_id == IdDetalle" >
                                <td class="align-middle">{{ item.det_id }}</td>
                                <td class="align-middle">{{ item.det_descp }}</td>
                                <td class="align-middle">{{ item.item_id }}</td>
                                <td class="align-middle"><input type="number" class="form-control" name="item_cant" value="{{ item.item_cant }}"></td>
                            
                            
                            <!-- <td class="align-middle">
                                {{ item.item_sector
                                }}<button class="btn text-danger" (click)="deleteItem(item.item_id)">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            </td> -->
                            <ng-container *ngFor="let sect of sectores$ | async">
                                <!-- <td *ngIf="sect.sectIdNomina == item.item_sector" class="align-middle">
                                    {{ sect.sectNombre }}
                                </td> -->
                                <td *ngIf="sect.sectIdNomina == item.item_sector" class="align-middle">
                                    <select class="form-select" name="item_sector" [(ngModel)]="item.item_sector">
                                      <option selected disabled value="0">Selecciona un sector...</option>
                                      <option *ngFor="let sect of sectores$ | async" [value]="sect.sectIdNomina">{{ sect.sectNombre }}</option>
                                    </select>
                                  </td>
                            </ng-container>
                            <td>
                                <button class="btn text-danger" (click)="deleteItem(item.item_id)">
                                    <i class="bi bi-x-circle"></i></button>
                            </td>
                        </ng-container>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" data-dismiss="modal">
                    Aceptar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para los items por sector-->
<div class="modal fade" #exampleModal id="itemsector" data-backdrop="static" tabindex="-1" role="dialog"
    aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header justify-content-center">
                <h3 class="font-weight-bold" id="exampleModalLabel">
                    Ingrese los items según el sector
                </h3>
            </div>
            <div class="modal-body">
                <table class="table table-striped text-center justify-content-center">
                    <thead>
                        <tr>
                            <th scope="col">N° Detalle</th>
                            <th scope="col">Descripción</th>
                            <th scope="col">N° Item</th>
                            <th scope="col">Cantidad*</th>
                            <th scope="col" colspan="2">Sector*</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let item of tmpItemSect">
                            <td class="align-middle">{{ item.det_id }}</td>
                            <td class="align-middle">{{ item.det_descp }}</td>
                            <td class="align-middle">{{ item.item_id }}</td>
                            <td class="align-middle">{{ item.item_cant }}</td>
                            <!-- <td class="align-middle">
                                {{ item.item_sector
                                }}<button class="btn text-danger" (click)="deleteItem(item.item_id)">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            </td> -->
                            <ng-container *ngFor="let sect of sectores$ | async">
                                <td *ngIf="sect.sectIdNomina == item.item_sector" class="align-middle">
                                    {{ sect.sectNombre }}
                                </td>
                            </ng-container>
                            <td>
                                <button class="btn text-danger" (click)="deleteItem(item.item_id)">
                                    <i class="bi bi-x-circle"></i></button>
                            </td>
                        </tr>
                        <tr>
                            <td class="align-middle">{{ det_id }}</td>
                            <td class="align-middle">
                                <input class="form-control" type="text" value="Descripción" [(ngModel)]="det_descp"
                                    placeholder="Descripción" disabled />
                            </td>
                            <td class="align-middle cel-prep">
                                <input type="text" class="form-control text-center" [(ngModel)]="item_id" disabled />
                            </td>
                            <td class="align-middle">
                                <div class="cel-prep">
                                    <input class="form-control" [(ngModel)]="item_cant" min="1" type="number"
                                        placeholder="Cantidad" />
                                </div>
                            </td>
                            <td class="align-middle" style="width: 150px" colspan="2">
                                <div class="cel-prep">
                                    <select class="form-select" name="item_sector" [(ngModel)]="item_sector">
                                        <option selected disabled value="0">
                                            Selecciona un sector...
                                        </option>
                                        <option *ngFor="let sect of sectores$ | async" [value]="sect.sectIdNomina">
                                            {{ sect.sectNombre }}
                                        </option>
                                    </select>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="6" class="align-middle text-end">
                                <button class="btn btn-success" [disabled]="!item_sector" (click)="addItemSector()">
                                    <i class="bi bi-check"></i>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal"
                    [disabled]="tmpItemSect.length === 0">
                    Confirmar
                </button>
                <button type="button" class="btn btn-danger" data-dismiss="modal" (click)="cancelarItem()">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
</div>


<!-- Modal para editar los items-->
<div class="modal fade" #exampleModal id="itemsectorEdit" data-backdrop="static" tabindex="-1" role="dialog"
    aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header justify-content-center">
                <h3 class="font-weight-bold" id="exampleModalLabel">
                    Editar items segun el sector
                </h3>
            </div>
            <div class="modal-body">
                <table class="table table-striped text-center justify-content-center">
                    <thead>
                        <tr>
                            <th scope="col">N° Detalle</th>
                            <th scope="col">Descripción</th>
                            <th scope="col">N° Item</th>
                            <th scope="col">Cantidad*</th>
                            <th scope="col" colspan="2">Sector*</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let itm of item; let i = index">
                            <ng-container *ngIf="idDetEdit == itm.itmIdDetalle">
                                <th class="align-middle">{{ itm.itmIdDetalle }}</th>
                                <ng-container *ngFor="let detd of detalle; let d = index">
                                    <td *ngIf="detd.solCotIdDetalle == itm.itmIdDetalle" class="align-middle">
                                        <input type="text" class="form-control" [value]="detd.solCotDescripcion"
                                            disabled>
                                    </td>
                                </ng-container>
                                <td class="align-middle">{{ itm.itmIdItem }}</td>
                                <td class="align-middle">{{ itm.itmCantidad }}</td>
                                <!-- <ng-container *ngFor="let detu of detalle; let d = index">
                                    <td *ngIf="detu.solCotIdDetalle == itm.itmIdDetalle" class="align-middle">
                                        {{ detu.solCotUnidad }}
                                    </td>
                                </ng-container> -->
                                <ng-container *ngFor="let sect of sectores$ | async">
                                    <td *ngIf="sect.sectIdNomina == itm.itmSector" class="align-middle">
                                        {{ sect.sectNombre }}
                                    </td>
                                </ng-container>
                                <td>
                                    <button class="btn text-danger" data-toggle="modal" data-target="#dltItemSaved"
                                        (click)="confDeleteItm(itm.itmID, itm.itmIdItem, itm.itmNumSol)">
                                        <i class="bi bi-x-circle"></i></button>
                                </td>
                            </ng-container>

                        </tr>
                        <tr>
                            <td class="align-middle">{{ det_id_edit }}</td>
                            <td class="align-middle">
                                <input class="form-control" type="text" value="Descripción" [(ngModel)]="det_descp_edit"
                                    placeholder="Descripción" disabled />
                            </td>
                            <td class="align-middle cel-prep">
                                <input type="text" class="form-control text-center" [(ngModel)]="item_id" disabled />
                            </td>
                            <td class="align-middle">
                                <div class="cel-prep">
                                    <input class="form-control" [(ngModel)]="item_cant" min="1" type="number"
                                        placeholder="Cantidad" />
                                </div>
                            </td>
                            <td class="align-middle" style="width: 150px" colspan="2">
                                <div class="cel-prep">
                                    <select class="form-select" name="item_sector" [(ngModel)]="item_sector">
                                        <option *ngFor="let sect of sectores$ | async" [value]="sect.sectIdNomina">
                                            {{ sect.sectNombre }}
                                        </option>
                                    </select>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="6" class="align-middle text-end">
                                <button class="btn btn-success" (click)="addNewItem()">
                                    <i class="bi bi-check"></i></button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" data-dismiss="modal" (click)="cancelarItem()">
                    Confirmar
                </button>
            </div>
        </div>
    </div>
</div>

<!--Modal para guardar edicion de solicitud  -->
<div class="modal fade" #exampleModal id="guardarCotizacion" data-backdrop="static" tabindex="-1" role="dialog"
    aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header justify-content-center">
                <h3 class="font-weight-bold" id="exampleModalLabel">
                    ¿Está seguro que desea guardar esta solicitud?
                </h3>
            </div>
            <div class="modal-body">
                <p>Esta acción guardará los datos ingresados en la solicitud pero no la enviará para su revisón.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal" (click)="check()">
                    Confirmar
                </button>
                <button type="button" class="btn btn-danger" data-dismiss="modal">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
</div>

<!--Modal para guardar edicion de solicitud  -->
<div class="modal fade" #exampleModal id="guardarEdicion" data-backdrop="static" tabindex="-1" role="dialog"
    aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header justify-content-center">
                <h3 class="font-weight-bold" id="exampleModalLabel">
                    ¿Está seguro que desea guardar los cambios realizados en la solicitud?
                </h3>
            </div>
            <div class="modal-body">
                <p>Esta acción guardará los cambios hechos en la solicitud pero no enviará la solicitud.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal" (click)="saveEdit()">
                    Confirmar
                </button>
                <button type="button" class="btn btn-danger" data-dismiss="modal">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para confirmar eliminacion de item-->
<div class="modal fade" #exampleModal id="dltItemSaved" data-backdrop="static" tabindex="-1" role="dialog"
    aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header justify-content-center">
                <h3 class="font-weight-bold" id="exampleModalLabel">
                    ¿Está seguro que desea eliminar este item?
                </h3>
            </div>
            <div class="modal-body">
                <p>Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal" (click)="deleteItemSaved()">
                    Confirmar
                </button>
                <button type="button" class="btn btn-danger" data-dismiss="modal">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para confirmar eliminacion de detalle-->
<div class="modal fade" #exampleModal id="dltDetSaved" data-backdrop="static" tabindex="-1" role="dialog"
    aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header justify-content-center">
                <h3 class="font-weight-bold" id="exampleModalLabel">
                    ¿Está seguro que desea eliminar este detalle?
                </h3>
            </div>
            <div class="modal-body">
                <p>Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal" (click)="deleteDetSaved()">
                    Confirmar
                </button>
                <button type="button" class="btn btn-danger" data-dismiss="modal">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
</div>


<!-- Modal para verificar el envío de la soliitud recien registrada-->
<div class="modal fade" #exampleModal id="enviarSolicitud" data-backdrop="static" tabindex="-1" role="dialog"
    aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header justify-content-center">
                <h3 class="font-weight-bold" id="exampleModalLabel">
                    ¿Está seguro que desea guardar la solicitud y enviarla para su revisión?
                </h3>
            </div>
            <div class="modal-body">
                <p>Al enviar la solicitud no podrá volver a editarla y pasará al sugiente estado.</p>
                <!-- <div>
                    <label for="nivGerencia" class="input-label">Notificar a:</label>
                    <select  id="nivGerencia" class="form-select" [(ngModel)]="mailToNotify">
                        <option value="" selected disabled>Seleccione una opción</option>
                        <ng-container *ngFor="let niv of nivGerencias">
                            <option *ngIf="niv.gerNivArea == areaUserCookie" [value]="niv.gerNivCorreo">{{niv.gerNivNombre}}</option>
                        </ng-container>
                    </select>
                </div> -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal" (click)="guardarEnviarSolNueva()">
                    Confirmar
                </button>
                <button type="button" class="btn btn-danger" data-dismiss="modal">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para verificar el envío de la solcitud guardada-->
<div class="modal fade" #exampleModal id="enviarSolicitudGuardada" data-backdrop="static" tabindex="-1" role="dialog"
    aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header justify-content-center">
                <h3 class="font-weight-bold" id="exampleModalLabel">
                    ¿Está seguro que desea guardar los cambios realizados en la solicitud y enviarla para su revisión?
                </h3>
            </div>
            <div class="modal-body">
                <p>Esta acción guardará los cambios hechos en la solicitud y enviará la solicitud a su siguiente estado.
                </p>
                <!-- <div>
                    <label for="nivGerencia" class="input-label">Notificar a:</label>
                    <select  id="nivGerencia" class="form-select" [(ngModel)]="mailToNotify">
                        <option value="" selected disabled>Seleccione una opción</option>
                        <ng-container *ngFor="let niv of nivGerencias">
                            <option *ngIf="niv.gerNivArea == areaUserCookie" [value]="niv.gerNivCorreo">{{niv.gerNivNombre}}</option>
                        </ng-container>
                    </select>
                </div> -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal" (click)="guardarEnviarSolEditada()">
                    Confirmar
                </button>
                <button type="button" class="btn btn-danger" data-dismiss="modal">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para verificar el envío de la soliitud recien registrada-->
<div class="modal fade" #exampleModal id="aprobarSolicitud" data-backdrop="static" tabindex="-1" role="dialog"
    aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header justify-content-center">
                <h3 class="font-weight-bold" id="exampleModalLabel">
                    ¿Está seguro que desea enviar esta solicitud?
                </h3>
            </div>
            <div class="modal-body">
                <p>Al enviar la solicitud no podrá volver a editarla y pasará al sugiente nivel.</p>
                <!-- <div *ngIf="estadoTrkTmp < 40">
                    <label for="nivGerencia" class="input-label">Notificar a:</label>
                    <select  id="nivGerencia" class="form-select" [(ngModel)]="mailToNotify">
                        <option value="" selected disabled>Seleccione una opción</option>
                        <ng-container *ngFor="let niv of nivGerencias">
                            <option *ngIf="niv.gerNivArea == areaUserCookie" [value]="niv.gerNivCorreo">{{niv.gerNivNombre}}</option>
                        </ng-container>
                    </select>
                </div> -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal" (click)="enviarSolicitud()">
                    Confirmar
                </button>
                <button type="button" class="btn btn-danger" data-dismiss="modal">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para verificar el envío de la soliitud recien registrada-->
<div class="modal fade" #exampleModal id="rechazarSolicitud" data-backdrop="static" tabindex="-1" role="dialog"
    aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header justify-content-center">
                <h3 class="font-weight-bold" id="exampleModalLabel">
                    ¿Está seguro que desea no autorizar esta solicitud?
                </h3>
            </div>
            <div class="modal-body">
                <p>Al no autorizar la solicitud, esta se regresará al nivel anterior para su revisión.</p>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal" (click)="noAutorizar()">
                    Confirmar
                </button>
                <button type="button" class="btn btn-danger" data-dismiss="modal">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
</div>


<!-- Modal para verificar el envío de la soliitud recien registrada-->
<div class="modal fade" #exampleModal id="anularSolicitud" data-backdrop="static" tabindex="-1" role="dialog"
    aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header justify-content-center">
                <h3 class="font-weight-bold" id="exampleModalLabel">
                    ¿Está seguro que desea anular esta solicitud?
                </h3>
            </div>
            <div class="modal-body">
                <p>Al anular la solicitud, esta tendrá el estado ANULADO y el proceso quedará finalizado.</p>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal" (click)="anularSolicitud()">
                    Confirmar
                </button>
                <button type="button" class="btn btn-danger" data-dismiss="modal">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
</div>